<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NutriScan ‚Äî Kalorir√§knare</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0d;
    --surface: #1a1a17;
    --surface2: #232320;
    --border: #2e2e2a;
    --accent: #c8f060;
    --text: #f0ede8;
    --muted: #7a7870;
    --danger: #ff6b5b;
    --protein: #60c8f0;
    --carbs: #f0a030;
    --fat: #f060a0;
    --kcal: #c8f060;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header { width: 100%; padding: 2rem 2rem 0; text-align: center; }
  header h1 { font-family: 'DM Serif Display', serif; font-size: clamp(2.5rem, 6vw, 4rem); letter-spacing: -0.02em; }
  header h1 span { color: var(--accent); font-style: italic; }
  header p { color: var(--muted); font-size: 0.8rem; margin-top: 0.4rem; letter-spacing: 0.1em; text-transform: uppercase; }

  /* Tab nav */
  .tab-nav {
    display: flex;
    gap: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px;
    width: 100%;
    max-width: 520px;
    margin: 1.5rem 1.5rem 0;
  }
  .tab-btn {
    flex: 1;
    padding: 0.6rem;
    background: transparent;
    border: none;
    border-radius: 8px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }
  .tab-btn.active { background: var(--surface2); color: var(--text); }
  .tab-btn:hover:not(.active) { color: var(--text); }

  .tab-content { display: none; }
  .tab-content.active { display: flex; flex-direction: column; gap: 1.5rem; }

  .main { width: 100%; max-width: 520px; padding: 1.5rem 1.5rem 4rem; display: flex; flex-direction: column; gap: 1.5rem; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; }
  .card-label { font-size: 0.7rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 1rem; }

  /* API Key */
  .api-note { font-size: 0.72rem; color: var(--muted); margin-bottom: 0.75rem; line-height: 1.6; }
  .api-note a { color: var(--accent); text-decoration: none; }
  .api-row { display: flex; gap: 0.5rem; }
  .api-row input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.85rem;
    padding: 0.6rem 0.9rem; outline: none; transition: border-color 0.2s;
  }
  .api-row input:focus { border-color: var(--accent); }
  .api-save-btn {
    padding: 0.6rem 1rem; background: var(--accent); color: var(--bg); border: none;
    border-radius: 8px; font-family: 'DM Mono', monospace; font-size: 0.78rem;
    font-weight: 500; cursor: pointer; white-space: nowrap; transition: background 0.2s;
  }
  .api-save-btn:hover { background: #d8ff70; }
  .api-status { font-size: 0.72rem; margin-top: 0.5rem; }

  /* Date nav */
  .date-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }
  .date-nav-btn {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-size: 1rem; width: 36px; height: 36px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
  }
  .date-nav-btn:hover { border-color: var(--accent); color: var(--accent); }
  .date-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .date-display {
    flex: 1; text-align: center;
    font-size: 0.9rem; font-weight: 500;
    cursor: pointer;
    transition: color 0.2s;
  }
  .date-display:hover { color: var(--accent); }
  .date-display .date-sub { font-size: 0.68rem; color: var(--muted); display: block; margin-top: 0.1rem; letter-spacing: 0.06em; }
  .today-btn {
    font-size: 0.68rem; background: transparent; border: 1px solid var(--border);
    border-radius: 6px; color: var(--muted); padding: 0.3rem 0.6rem;
    cursor: pointer; font-family: 'DM Mono', monospace; transition: all 0.2s; white-space: nowrap;
  }
  .today-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Upload */
  .upload-zone {
    border: 1.5px dashed var(--border); border-radius: 12px; padding: 2.5rem 1rem;
    text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
  }
  .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: rgba(200,240,96,0.04); }
  .upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; display: block; }
  .upload-zone p { font-size: 0.85rem; color: var(--muted); line-height: 1.6; }
  .upload-zone strong { color: var(--accent); font-weight: 500; }

  .camera-btn {
    display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem;
    padding: 0.6rem 1.2rem; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-family: 'DM Mono', monospace;
    font-size: 0.78rem; cursor: pointer; transition: all 0.2s; position: relative; z-index: 2;
  }
  .camera-btn:hover { border-color: var(--accent); color: var(--accent); }

  #preview-container { display: none; margin-top: 1rem; border-radius: 10px; overflow: hidden; position: relative; }
  #preview-container img { width: 100%; border-radius: 10px; max-height: 280px; object-fit: cover; }
  .remove-img {
    position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7);
    border: none; color: white; width: 28px; height: 28px; border-radius: 50%;
    cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center;
  }

  .error-msg {
    background: rgba(255,107,91,0.1); border: 1px solid rgba(255,107,91,0.3);
    border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.8rem; color: var(--danger);
    display: none; margin-top: 0.75rem;
  }

  .analyze-btn {
    width: 100%; margin-top: 1rem; padding: 1rem; background: var(--accent); color: var(--bg);
    border: none; border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 0.9rem;
    font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer;
    transition: all 0.2s; display: none;
  }
  .analyze-btn:hover { background: #d8ff70; transform: translateY(-1px); }
  .analyze-btn:active { transform: translateY(0); }
  .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .loading { display: none; text-align: center; padding: 1.5rem; color: var(--muted); font-size: 0.8rem; letter-spacing: 0.08em; }
  .spinner {
    display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite;
    margin-right: 0.75rem; vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Manual */
  .manual-btn {
    width: 100%; padding: 0.7rem; background: transparent; border: 1px dashed var(--border);
    color: var(--muted); border-radius: 8px; font-family: 'DM Mono', monospace;
    font-size: 0.75rem; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s;
  }
  .manual-btn:hover { border-color: var(--muted); color: var(--text); }
  .manual-form { display: none; margin-top: 1rem; }
  .manual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem; }
  .manual-field { display: flex; flex-direction: column; gap: 0.4rem; }
  .manual-field.full { grid-column: 1 / -1; }
  .manual-field label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); }
  .manual-field input {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.9rem;
    padding: 0.55rem 0.75rem; outline: none; transition: border-color 0.2s; width: 100%;
  }
  .manual-field input:focus { border-color: var(--accent); }
  .use-manual-btn {
    width: 100%; padding: 0.75rem; background: var(--surface2); border: 1px solid var(--accent);
    color: var(--accent); border-radius: 8px; font-family: 'DM Mono', monospace;
    font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;
  }
  .use-manual-btn:hover { background: rgba(200,240,96,0.08); }

  /* Nutrition panel */
  #nutrition-panel { display: none; animation: slideUp 0.4s ease; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  .product-name { font-family: 'DM Serif Display', serif; font-size: 1.4rem; margin-bottom: 0.25rem; }
  .per-100g { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 1.25rem; }

  .macros-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.25rem; }
  .macro-card { background: var(--surface2); border-radius: 10px; padding: 1rem; border-left: 3px solid; }
  .macro-card.kcal { border-color: var(--kcal); grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; }
  .macro-card.protein { border-color: var(--protein); }
  .macro-card.carbs { border-color: var(--carbs); }
  .macro-card.fat { border-color: var(--fat); }
  .macro-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 0.3rem; }
  .macro-value { font-size: 1.5rem; font-weight: 500; line-height: 1; }
  .macro-unit { font-size: 0.75rem; color: var(--muted); margin-left: 0.2rem; }
  .macro-card.kcal .macro-value { font-size: 2rem; }

  .grams-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
  .grams-row { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1rem; }
  .grams-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; white-space: nowrap; }
  .grams-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 1.1rem;
    padding: 0.6rem 0.9rem; outline: none; transition: border-color 0.2s; max-width: 120px; text-align: center;
  }
  .grams-input:focus { border-color: var(--accent); }
  .grams-input-unit { font-size: 0.8rem; color: var(--muted); }

  #calc-results { background: var(--surface2); border-radius: 12px; padding: 1.25rem; display: none; }
  .calc-header { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); margin-bottom: 1rem; }
  .calc-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
  .calc-row:last-child { border-bottom: none; }
  .calc-name { font-size: 0.8rem; color: var(--muted); }
  .calc-val { font-size: 1rem; font-weight: 500; }
  .calc-val.kcal-val { color: var(--kcal); font-size: 1.2rem; }
  .calc-val.protein-val { color: var(--protein); }
  .calc-val.carbs-val { color: var(--carbs); }
  .calc-val.fat-val { color: var(--fat); }

  .log-btn {
    width: 100%; margin-top: 1rem; padding: 0.8rem; background: transparent;
    border: 1px solid var(--accent); color: var(--accent); border-radius: 8px;
    font-family: 'DM Mono', monospace; font-size: 0.8rem; letter-spacing: 0.08em;
    text-transform: uppercase; cursor: pointer; transition: all 0.2s; display: none;
  }
  .log-btn:hover { background: rgba(200,240,96,0.08); }

  /* Daily log */
  .log-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.9rem 0; border-bottom: 1px solid var(--border); animation: slideUp 0.3s ease;
  }
  .log-item:last-child { border-bottom: none; }
  .log-item-name { font-size: 0.85rem; color: var(--text); margin-bottom: 0.15rem; }
  .log-item-detail { font-size: 0.7rem; color: var(--muted); }
  .log-item-kcal { color: var(--kcal); font-size: 1rem; font-weight: 500; }
  .edit-log { background: none; border: none; color: var(--muted); cursor: pointer; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.85rem; transition: color 0.2s; }
  .edit-log:hover { color: var(--accent); }
  .delete-log { background: none; border: none; color: var(--muted); cursor: pointer; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.85rem; transition: color 0.2s; }
  .delete-log:hover { color: var(--danger); }

  .totals-bar { background: var(--surface2); border-radius: 10px; padding: 1rem; margin-top: 0.75rem; }
  .totals-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); margin-bottom: 0.75rem; }
  .totals-row { display: flex; justify-content: space-between; }
  .total-item { text-align: center; }
  .total-item .val { font-size: 1.1rem; font-weight: 500; }
  .total-item .lbl { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }

  .empty-log { text-align: center; color: var(--muted); font-size: 0.82rem; padding: 2rem 1rem; line-height: 1.8; }

  /* History tab */
  .history-day {
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    animation: slideUp 0.3s ease;
  }
  .history-day-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
  }
  .history-day-header:hover { background: var(--surface2); }
  .history-day-date { font-family: 'DM Serif Display', serif; font-size: 1.1rem; }
  .history-day-kcal { color: var(--kcal); font-size: 0.95rem; font-weight: 500; }
  .history-day-chevron { color: var(--muted); font-size: 0.8rem; transition: transform 0.2s; }
  .history-day.open .history-day-chevron { transform: rotate(180deg); }
  .history-day-body { display: none; padding: 0 1.25rem 1rem; border-top: 1px solid var(--border); }
  .history-day.open .history-day-body { display: block; }
  .history-macros { display: flex; gap: 1rem; padding: 0.75rem 0; font-size: 0.75rem; color: var(--muted); border-bottom: 1px solid var(--border); margin-bottom: 0.5rem; }
  .history-macros span { color: var(--text); }

  .no-history { text-align: center; color: var(--muted); font-size: 0.82rem; padding: 3rem 1rem; line-height: 1.8; }

  /* Quick add button */
  .quick-add-btn {
    width: 100%; padding: 0.9rem; background: var(--accent); color: var(--bg);
    border: none; border-radius: 10px; font-family: 'DM Mono', monospace;
    font-size: 0.88rem; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase;
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  }
  .quick-add-btn:hover { background: #d8ff70; transform: translateY(-1px); }
  .quick-add-btn:active { transform: translateY(0); }

  /* Quick-add modal */
  .qa-modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    width: 94%; max-width: 480px; max-height: 90vh; overflow-y: auto;
    animation: slideUp 0.3s ease; display: flex; flex-direction: column;
  }
  .qa-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .qa-title { font-family: 'DM Serif Display', serif; font-size: 1.3rem; }
  .qa-close {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--muted); width: 32px; height: 32px; cursor: pointer;
    font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
  }
  .qa-close:hover { color: var(--text); border-color: var(--muted); }
  .qa-body { padding: 1.25rem 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }

  .qa-step { display: none; flex-direction: column; gap: 1rem; }
  .qa-step.active { display: flex; }

  .qa-upload-zone {
    border: 1.5px dashed var(--border); border-radius: 10px; padding: 1.5rem 1rem;
    text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
  }
  .qa-upload-zone:hover { border-color: var(--accent); background: rgba(200,240,96,0.04); }
  .qa-upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .qa-upload-zone p { font-size: 0.8rem; color: var(--muted); }
  .qa-upload-zone strong { color: var(--accent); }

  .qa-cam-btn {
    width: 100%; padding: 0.7rem; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-family: 'DM Mono', monospace;
    font-size: 0.78rem; cursor: pointer; transition: all 0.2s; position: relative; z-index: 2;
  }
  .qa-cam-btn:hover { border-color: var(--accent); color: var(--accent); }

  .qa-preview { display: none; border-radius: 10px; overflow: hidden; position: relative; }
  .qa-preview img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; }
  .qa-remove-img {
    position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7);
    border: none; color: white; width: 26px; height: 26px; border-radius: 50%;
    cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center;
  }

  .qa-analyze-btn {
    width: 100%; padding: 0.9rem; background: var(--accent); color: var(--bg);
    border: none; border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 0.85rem;
    font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer;
    transition: all 0.2s; display: none;
  }
  .qa-analyze-btn:hover { background: #d8ff70; }
  .qa-analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .qa-error {
    background: rgba(255,107,91,0.1); border: 1px solid rgba(255,107,91,0.3);
    border-radius: 8px; padding: 0.65rem 0.9rem; font-size: 0.78rem; color: var(--danger); display: none;
  }
  .qa-loading { display: none; text-align: center; padding: 1rem; color: var(--muted); font-size: 0.8rem; }

  .qa-or { display: flex; align-items: center; gap: 0.75rem; font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; }
  .qa-or::before, .qa-or::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .qa-manual-toggle {
    width: 100%; padding: 0.6rem; background: transparent; border: 1px dashed var(--border);
    color: var(--muted); border-radius: 8px; font-family: 'DM Mono', monospace;
    font-size: 0.72rem; cursor: pointer; transition: all 0.2s;
  }
  .qa-manual-toggle:hover { border-color: var(--muted); color: var(--text); }
  .qa-manual-form { display: none; }
  .qa-mini-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; margin-bottom: 0.6rem; }
  .qa-mini-field { display: flex; flex-direction: column; gap: 0.3rem; }
  .qa-mini-field.full { grid-column: 1/-1; }
  .qa-mini-field label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); }
  .qa-mini-field input {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.88rem;
    padding: 0.5rem 0.7rem; outline: none; transition: border-color 0.2s; width: 100%;
  }
  .qa-mini-field input:focus { border-color: var(--accent); }
  .qa-use-manual {
    width: 100%; padding: 0.65rem; background: var(--surface2); border: 1px solid var(--accent);
    color: var(--accent); border-radius: 8px; font-family: 'DM Mono', monospace;
    font-size: 0.78rem; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;
  }
  .qa-use-manual:hover { background: rgba(200,240,96,0.08); }

  .qa-result-name { font-family: 'DM Serif Display', serif; font-size: 1.2rem; margin-bottom: 0.2rem; }
  .qa-result-sub { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 1rem; }
  .qa-macros-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
  .qa-macro { background: var(--surface2); border-radius: 8px; padding: 0.6rem 0.4rem; text-align: center; border-top: 2px solid; }
  .qa-macro.kcal { border-color: var(--kcal); }
  .qa-macro.protein { border-color: var(--protein); }
  .qa-macro.carbs { border-color: var(--carbs); }
  .qa-macro.fat { border-color: var(--fat); }
  .qa-macro-val { font-size: 1rem; font-weight: 500; }
  .qa-macro-lbl { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 0.2rem; }

  .qa-grams-row { display: flex; gap: 0.75rem; align-items: center; }
  .qa-grams-lbl { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; white-space: nowrap; }
  .qa-grams-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 1.1rem;
    padding: 0.6rem 0.9rem; outline: none; transition: border-color 0.2s; max-width: 100px; text-align: center;
  }
  .qa-grams-input:focus { border-color: var(--accent); }
  .qa-grams-unit { font-size: 0.8rem; color: var(--muted); }
  .qa-calc-box { background: var(--surface2); border-radius: 10px; padding: 0.9rem 1rem; }
  .qa-calc-row { display: flex; justify-content: space-between; align-items: center; padding: 0.35rem 0; border-bottom: 1px solid var(--border); font-size: 0.82rem; }
  .qa-calc-row:last-child { border-bottom: none; }
  .qa-calc-name { color: var(--muted); }
  .qa-calc-val { font-weight: 500; }
  .qa-add-btn {
    width: 100%; padding: 1rem; background: var(--accent); color: var(--bg);
    border: none; border-radius: 10px; font-family: 'DM Mono', monospace; font-size: 0.9rem;
    font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;
  }
  .qa-add-btn:hover { background: #d8ff70; }

  /* Edit modal */
  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 1.75rem; width: 90%; max-width: 360px; animation: slideUp 0.25s ease; }
  .modal-title { font-family: 'DM Serif Display', serif; font-size: 1.2rem; margin-bottom: 0.25rem; }
  .modal-subtitle { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1.25rem; }
  .modal-field { display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 1rem; }
  .modal-field label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); }
  .modal-field input {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 1.1rem;
    padding: 0.6rem 0.9rem; outline: none; transition: border-color 0.2s; width: 100%;
  }
  .modal-field input:focus { border-color: var(--accent); }
  .modal-preview {
    background: var(--surface2); border-radius: 8px; padding: 0.75rem 1rem;
    margin-bottom: 1.25rem; display: grid; grid-template-columns: 1fr 1fr;
    gap: 0.4rem 1rem; font-size: 0.78rem;
  }
  .modal-preview span { color: var(--muted); }
  .modal-preview strong { color: var(--text); }
  .modal-actions { display: flex; gap: 0.75rem; }
  .modal-save {
    flex: 1; padding: 0.75rem; background: var(--accent); color: var(--bg); border: none;
    border-radius: 8px; font-family: 'DM Mono', monospace; font-size: 0.82rem;
    font-weight: 500; cursor: pointer; transition: background 0.2s;
  }
  .modal-save:hover { background: #d8ff70; }
  .modal-cancel {
    padding: 0.75rem 1.25rem; background: transparent; color: var(--muted);
    border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Mono', monospace;
    font-size: 0.82rem; cursor: pointer; transition: all 0.2s;
  }
  .modal-cancel:hover { color: var(--text); border-color: var(--muted); }
</style>
</head>
<body>

<header>
  <h1>Nutri<span>Scan</span></h1>
  <p>Fotobaserad n√§ringsr√§knare</p>
</header>

<!-- Tab navigation -->
<div style="width:100%;max-width:520px;padding:1.5rem 1.5rem 0;">
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('logg')">üìã Logg</button>
    <button class="tab-btn" onclick="switchTab('skanna')">üì∏ Skanna</button>
    <button class="tab-btn" onclick="switchTab('historik')">üìÖ Historik</button>
    <button class="tab-btn" onclick="switchTab('installningar')">‚öôÔ∏è Inst.</button>
  </div>
</div>

<div class="main">

  <!-- LOGG TAB -->
  <div id="tab-logg" class="tab-content active">

    <!-- Date navigator -->
    <div class="card">
      <div class="date-nav">
        <button class="date-nav-btn" onclick="changeDay(-1)">‚Äπ</button>
        <div class="date-display" onclick="goToToday()">
          <span id="date-display-main">‚Äî</span>
          <span class="date-sub" id="date-display-sub"></span>
        </div>
        <button class="date-nav-btn" id="next-day-btn" onclick="changeDay(1)">‚Ä∫</button>
        <button class="today-btn" id="today-btn" onclick="goToToday()" style="display:none">Idag</button>
      </div>
    </div>

    <!-- Quick add button -->
    <button class="quick-add-btn" onclick="openQuickAdd()">
      <span style="font-size:1.1rem">+</span> L√§gg till mat
    </button>

    <!-- Daily log for selected day -->
    <div class="card" id="daily-log-card">
      <div class="card-label">Dagens intag</div>
      <div id="log-items"></div>
      <div class="totals-bar">
        <div class="totals-label">Dagens totalt</div>
        <div class="totals-row">
          <div class="total-item"><div class="val" style="color:var(--kcal)" id="t-kcal">0</div><div class="lbl">kcal</div></div>
          <div class="total-item"><div class="val" style="color:var(--protein)" id="t-protein">0g</div><div class="lbl">protein</div></div>
          <div class="total-item"><div class="val" style="color:var(--carbs)" id="t-carbs">0g</div><div class="lbl">kolhydrater</div></div>
          <div class="total-item"><div class="val" style="color:var(--fat)" id="t-fat">0g</div><div class="lbl">fett</div></div>
        </div>
      </div>
    </div>

  </div>

  <!-- SKANNA TAB -->
  <div id="tab-skanna" class="tab-content">

    <!-- Scan -->
    <div class="card">
      <div class="card-label">üì∏ Skanna etikett</div>
      <div class="upload-zone" id="upload-zone">
        <input type="file" id="file-input" accept="image/*">
        <span class="upload-icon">ü•´</span>
        <p>Sl√§pp ett foto p√• din <strong>n√§ringsetikett</strong><br>eller klicka f√∂r att ladda upp</p>
        <button class="camera-btn" onclick="triggerCamera(event)">üì∑ Ta foto</button>
      </div>
      <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none">
      <div id="preview-container">
        <img id="preview-img" src="" alt="F√∂rhandsgranskning">
        <button class="remove-img" onclick="removeImage()">‚úï</button>
      </div>
      <div class="error-msg" id="error-msg"></div>
      <button class="analyze-btn" id="analyze-btn" onclick="analyzeImage()">‚ú¶ Analysera n√§ringsetikett</button>
      <div class="loading" id="loading"><span class="spinner"></span>L√§ser n√§ringsetiketten...</div>
    </div>

    <!-- Manual entry -->
    <div class="card">
      <div class="card-label">‚úèÔ∏è Ange manuellt</div>
      <button class="manual-btn" onclick="toggleManual()">Ange n√§ringsv√§rden manuellt ‚Üí</button>
      <div class="manual-form" id="manual-form">
        <div class="manual-grid">
          <div class="manual-field full">
            <label>Produktnamn</label>
            <input type="text" id="m-name" placeholder="t.ex. Grekisk yoghurt">
          </div>
          <div class="manual-field">
            <label>Kcal / 100g</label>
            <input type="number" id="m-kcal" placeholder="89">
          </div>
          <div class="manual-field">
            <label>Protein (g)</label>
            <input type="number" id="m-protein" placeholder="10">
          </div>
          <div class="manual-field">
            <label>Kolhydrater (g)</label>
            <input type="number" id="m-carbs" placeholder="3.6">
          </div>
          <div class="manual-field">
            <label>Fett (g)</label>
            <input type="number" id="m-fat" placeholder="0.4">
          </div>
        </div>
        <button class="use-manual-btn" onclick="useManual()">Anv√§nd dessa v√§rden</button>
      </div>
    </div>

    <!-- Nutrition panel -->
    <div class="card" id="nutrition-panel">
      <div class="card-label">üìä N√§ringsinformation</div>
      <div class="product-name" id="p-name">‚Äî</div>
      <div class="per-100g">Per 100g</div>
      <div class="macros-grid">
        <div class="macro-card kcal">
          <div>
            <div class="macro-label">Energi</div>
            <div class="macro-value" id="p-kcal" style="color:var(--kcal)">‚Äî<span class="macro-unit">kcal</span></div>
          </div>
          <div style="font-size:1.8rem">üî•</div>
        </div>
        <div class="macro-card protein">
          <div class="macro-label">Protein</div>
          <div class="macro-value" id="p-protein" style="color:var(--protein)">‚Äî<span class="macro-unit">g</span></div>
        </div>
        <div class="macro-card carbs">
          <div class="macro-label">Kolhydrater</div>
          <div class="macro-value" id="p-carbs" style="color:var(--carbs)">‚Äî<span class="macro-unit">g</span></div>
        </div>
        <div class="macro-card fat">
          <div class="macro-label">Fett</div>
          <div class="macro-value" id="p-fat" style="color:var(--fat)">‚Äî<span class="macro-unit">g</span></div>
        </div>
      </div>
      <div class="grams-section">
        <div class="grams-row">
          <span class="grams-label">M√§ngd √§tit:</span>
          <input type="number" class="grams-input" id="grams-input" value="100" min="1" max="5000" oninput="calcNutrition()">
          <span class="grams-input-unit">gram</span>
        </div>
        <div id="calc-results">
          <div class="calc-header">Ber√§knat f√∂r <span id="calc-grams">100</span>g</div>
          <div class="calc-row"><span class="calc-name">üî• Energi</span><span class="calc-val kcal-val" id="c-kcal">‚Äî</span></div>
          <div class="calc-row"><span class="calc-name">üí™ Protein</span><span class="calc-val protein-val" id="c-protein">‚Äî</span></div>
          <div class="calc-row"><span class="calc-name">üåæ Kolhydrater</span><span class="calc-val carbs-val" id="c-carbs">‚Äî</span></div>
          <div class="calc-row"><span class="calc-name">üßà Fett</span><span class="calc-val fat-val" id="c-fat">‚Äî</span></div>
        </div>
        <button class="log-btn" id="log-btn" onclick="logFood()">+ L√§gg till i daglig logg</button>
      </div>
    </div>

  </div>

  <!-- HISTORIK TAB -->
  <div id="tab-historik" class="tab-content">
    <div class="card">
      <div class="card-label">üìÖ Loggade dagar</div>
      <div id="history-list"></div>
    </div>
  </div>

  <!-- INST√ÑLLNINGAR TAB -->
  <div id="tab-installningar" class="tab-content">
    <div class="card">
      <div class="card-label">üîë Google Gemini API-nyckel</div>
      <div class="api-note">
        H√§mta en gratis nyckel p√• <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a>. Nyckeln sparas i din webbl√§sare.
      </div>
      <div class="api-row">
        <input type="password" id="api-key-input" placeholder="AIza...">
        <button class="api-save-btn" onclick="saveApiKey()">Spara</button>
      </div>
      <div class="api-status" id="api-status"></div>
    </div>
  </div>

</div>

<!-- Quick-add modal -->
<div class="modal-overlay" id="qa-modal-overlay">
  <div class="qa-modal">
    <div class="qa-header">
      <div class="qa-title">L√§gg till mat</div>
      <button class="qa-close" onclick="closeQuickAdd()">‚úï</button>
    </div>
    <div class="qa-body">

      <!-- Step 1: scan/upload -->
      <div class="qa-step active" id="qa-step-scan">
        <div class="qa-upload-zone" id="qa-upload-zone">
          <input type="file" id="qa-file-input" accept="image/*">
          <div style="font-size:2rem;margin-bottom:0.5rem">üì∑</div>
          <p>Klicka eller dra en bild av <strong>n√§ringsetiketten</strong></p>
        </div>
        <button class="qa-cam-btn" onclick="triggerQACamera(event)">üì∑ Ta foto med kamera</button>
        <input type="file" id="qa-camera-input" accept="image/*" capture="environment" style="display:none">

        <div class="qa-preview" id="qa-preview">
          <img id="qa-preview-img" src="" alt="">
          <button class="qa-remove-img" onclick="removeQAImage()">‚úï</button>
        </div>

        <div class="qa-error" id="qa-error"></div>
        <button class="qa-analyze-btn" id="qa-analyze-btn" onclick="qaAnalyzeImage()">‚ú¶ Analysera etikett</button>
        <div class="qa-loading" id="qa-loading"><span class="spinner"></span>L√§ser etiketten...</div>

        <div class="qa-or">eller</div>

        <button class="qa-manual-toggle" onclick="toggleQAManual()">Ange n√§ringsv√§rden manuellt ‚Üí</button>
        <div class="qa-manual-form" id="qa-manual-form">
          <div class="qa-mini-grid">
            <div class="qa-mini-field full">
              <label>Produktnamn</label>
              <input type="text" id="qa-m-name" placeholder="t.ex. Havregryn">
            </div>
            <div class="qa-mini-field">
              <label>Kcal / 100g</label>
              <input type="number" id="qa-m-kcal" placeholder="375">
            </div>
            <div class="qa-mini-field">
              <label>Protein (g)</label>
              <input type="number" id="qa-m-protein" placeholder="13">
            </div>
            <div class="qa-mini-field">
              <label>Kolhydrater (g)</label>
              <input type="number" id="qa-m-carbs" placeholder="60">
            </div>
            <div class="qa-mini-field">
              <label>Fett (g)</label>
              <input type="number" id="qa-m-fat" placeholder="7">
            </div>
          </div>
          <button class="qa-use-manual" onclick="qaUseManual()">Anv√§nd dessa v√§rden ‚Üí</button>
        </div>
      </div>

      <!-- Step 2: grams + confirm -->
      <div class="qa-step" id="qa-step-confirm">
        <div>
          <div class="qa-result-name" id="qa-result-name">‚Äî</div>
          <div class="qa-result-sub">N√§ringsv√§rde per 100g</div>
          <div class="qa-macros-row">
            <div class="qa-macro kcal">
              <div class="qa-macro-val" id="qa-p-kcal" style="color:var(--kcal)">‚Äî</div>
              <div class="qa-macro-lbl">kcal</div>
            </div>
            <div class="qa-macro protein">
              <div class="qa-macro-val" id="qa-p-protein" style="color:var(--protein)">‚Äî</div>
              <div class="qa-macro-lbl">protein</div>
            </div>
            <div class="qa-macro carbs">
              <div class="qa-macro-val" id="qa-p-carbs" style="color:var(--carbs)">‚Äî</div>
              <div class="qa-macro-lbl">kolh.</div>
            </div>
            <div class="qa-macro fat">
              <div class="qa-macro-val" id="qa-p-fat" style="color:var(--fat)">‚Äî</div>
              <div class="qa-macro-lbl">fett</div>
            </div>
          </div>
        </div>

        <div class="qa-grams-row">
          <span class="qa-grams-lbl">M√§ngd √§tit:</span>
          <input type="number" class="qa-grams-input" id="qa-grams" value="100" min="1" max="5000" oninput="qaCalc()">
          <span class="qa-grams-unit">gram</span>
        </div>

        <div class="qa-calc-box">
          <div class="qa-calc-row"><span class="qa-calc-name">üî• Energi</span><span class="qa-calc-val" id="qa-c-kcal" style="color:var(--kcal)">‚Äî</span></div>
          <div class="qa-calc-row"><span class="qa-calc-name">üí™ Protein</span><span class="qa-calc-val" id="qa-c-protein" style="color:var(--protein)">‚Äî</span></div>
          <div class="qa-calc-row"><span class="qa-calc-name">üåæ Kolhydrater</span><span class="qa-calc-val" id="qa-c-carbs" style="color:var(--carbs)">‚Äî</span></div>
          <div class="qa-calc-row"><span class="qa-calc-name">üßà Fett</span><span class="qa-calc-val" id="qa-c-fat" style="color:var(--fat)">‚Äî</span></div>
        </div>

        <div style="display:flex;gap:0.75rem">
          <button onclick="qaBackToScan()" style="padding:1rem 1.2rem;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--muted);font-family:'DM Mono',monospace;font-size:0.82rem;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='var(--muted)'" onmouseout="this.style.borderColor='var(--border)'">‚Üê Tillbaka</button>
          <button class="qa-add-btn" onclick="qaLogFood()">+ L√§gg till i loggen</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Edit modal -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-title" id="modal-product-name">Produkt</div>
    <div class="modal-subtitle">Redigera portion</div>
    <div class="modal-field">
      <label>Antal gram</label>
      <input type="number" id="modal-grams" min="1" max="5000" oninput="updateModalPreview()">
    </div>
    <div class="modal-preview">
      <span>üî• Energi</span>    <strong id="mp-kcal">‚Äî</strong>
      <span>üí™ Protein</span>   <strong id="mp-protein">‚Äî</strong>
      <span>üåæ Kolhydrater</span><strong id="mp-carbs">‚Äî</strong>
      <span>üßà Fett</span>      <strong id="mp-fat">‚Äî</strong>
    </div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeEditModal()">Avbryt</button>
      <button class="modal-save" onclick="saveEdit()">Spara √§ndringar</button>
    </div>
  </div>
</div>

<script>
// =====================
// STATE
// =====================
let currentNutrition = null;
let imageBase64 = null;
let imageMimeType = 'image/jpeg';
let editingId = null;
let editingDate = null;
let activeTab = 'logg';

// Current viewed date (YYYY-MM-DD)
let viewingDate = getTodayKey();

function getTodayKey() {
  return new Date().toISOString().slice(0, 10);
}

function getDateLabel(key) {
  const today = getTodayKey();
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
  const yKey = yesterday.toISOString().slice(0, 10);
  if (key === today) return 'Idag';
  if (key === yKey) return 'Ig√•r';
  const d = new Date(key + 'T12:00:00');
  return d.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' });
}

function getDateSubLabel(key) {
  const d = new Date(key + 'T12:00:00');
  return d.toLocaleDateString('sv-SE', { year: 'numeric', month: 'long', day: 'numeric' });
}

// =====================
// STORAGE
// =====================
function loadDayEntries(dateKey) {
  try {
    const data = localStorage.getItem('nutriscan_day_' + dateKey);
    return data ? JSON.parse(data) : [];
  } catch(e) { return []; }
}

function saveDayEntries(dateKey, entries) {
  localStorage.setItem('nutriscan_day_' + dateKey, JSON.stringify(entries));
}

function getAllLoggedDays() {
  const days = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('nutriscan_day_')) {
      const dateKey = key.replace('nutriscan_day_', '');
      const entries = loadDayEntries(dateKey);
      if (entries.length > 0) days.push(dateKey);
    }
  }
  return days.sort((a, b) => b.localeCompare(a)); // newest first
}

// =====================
// TABS
// =====================
function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  event.currentTarget.classList.add('active');
  if (tab === 'historik') renderHistory();
}

// =====================
// DATE NAV
// =====================
function updateDateDisplay() {
  const today = getTodayKey();
  document.getElementById('date-display-main').textContent = getDateLabel(viewingDate);
  document.getElementById('date-display-sub').textContent = viewingDate === today ? getDateSubLabel(viewingDate) : '';
  document.getElementById('next-day-btn').disabled = viewingDate >= today;
  document.getElementById('today-btn').style.display = viewingDate !== today ? 'block' : 'none';
}

function changeDay(delta) {
  const d = new Date(viewingDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  const newKey = d.toISOString().slice(0, 10);
  const today = getTodayKey();
  if (newKey <= today) {
    viewingDate = newKey;
    updateDateDisplay();
    renderLog();
  }
}

function goToToday() {
  viewingDate = getTodayKey();
  updateDateDisplay();
  renderLog();
}

// =====================
// API KEY
// =====================
function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) return;
  localStorage.setItem('gemini_api_key', key);
  setApiStatus('‚úì Nyckel sparad!', 'var(--accent)');
  setTimeout(() => setApiStatus('', 'var(--muted)'), 3000);
}
function getApiKey() {
  return localStorage.getItem('gemini_api_key') || document.getElementById('api-key-input').value.trim();
}
function setApiStatus(msg, color) {
  const el = document.getElementById('api-status');
  el.textContent = msg; el.style.color = color;
}

// =====================
// FILE UPLOAD
// =====================
const fileInput = document.getElementById('file-input');
const cameraInput = document.getElementById('camera-input');
const uploadZone = document.getElementById('upload-zone');

fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
cameraInput.addEventListener('change', e => handleFile(e.target.files[0]));

function triggerCamera(e) {
  e.stopPropagation(); e.preventDefault();
  cameraInput.click();
}

uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault(); uploadZone.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});

function handleFile(file) {
  if (!file || !file.type.startsWith('image/')) return;
  imageMimeType = file.type || 'image/jpeg';
  const reader = new FileReader();
  reader.onload = ev => {
    const dataUrl = ev.target.result;
    imageBase64 = dataUrl.split(',')[1];
    document.getElementById('preview-img').src = dataUrl;
    document.getElementById('preview-container').style.display = 'block';
    document.getElementById('analyze-btn').style.display = 'block';
    hideError();
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  imageBase64 = null;
  document.getElementById('preview-container').style.display = 'none';
  document.getElementById('analyze-btn').style.display = 'none';
  fileInput.value = '';
}

// =====================
// GEMINI ANALYZE
// =====================
async function analyzeImage() {
  if (!imageBase64) return;
  const apiKey = getApiKey();
  if (!apiKey) { showError('Ange din Gemini API-nyckel under Inst√§llningar f√∂rst.'); return; }

  showLoading(true); hideError();

  try {
    const response = await fetch(
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + apiKey,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { inline_data: { mime_type: imageMimeType, data: imageBase64 } },
              { text: 'Analysera denna n√§ringsetikettsbild och extrahera n√§ringsv√§rdena per 100g.\nSvara ENDAST med ett giltigt JSON-objekt, ingen markdown, ingen f√∂rklaring:\n{"product_name":"produktnamn eller b√§sta gissning","kcal":number,"protein":number,"carbs":number,"fat":number}\nOm v√§rdena √§r per portion, konvertera till per 100g. Returnera alltid JSON.' }
            ]
          }]
        })
      }
    );
    const data = await response.json();
    if (!response.ok) throw new Error(data?.error?.message || 'API-fel');
    const text = data.candidates?.[0]?.content?.parts?.map(p => p.text || '').join('') || '';
    const clean = text.replace(/```json|```/g, '').trim();
    setNutrition(JSON.parse(clean));
  } catch(err) {
    showError('Kunde inte l√§sa etiketten: ' + (err.message || 'ok√§nt fel') + '. Kontrollera din API-nyckel eller ange v√§rden manuellt.');
  }
  showLoading(false);
}

// =====================
// NUTRITION DISPLAY
// =====================
function setNutrition(n) {
  currentNutrition = n;
  document.getElementById('p-name').textContent = n.product_name || 'Produkt';
  document.getElementById('p-kcal').innerHTML = Math.round(n.kcal) + '<span class="macro-unit">kcal</span>';
  document.getElementById('p-protein').innerHTML = (+n.protein).toFixed(1) + '<span class="macro-unit">g</span>';
  document.getElementById('p-carbs').innerHTML = (+n.carbs).toFixed(1) + '<span class="macro-unit">g</span>';
  document.getElementById('p-fat').innerHTML = (+n.fat).toFixed(1) + '<span class="macro-unit">g</span>';
  document.getElementById('nutrition-panel').style.display = 'block';
  document.getElementById('calc-results').style.display = 'block';
  document.getElementById('log-btn').style.display = 'block';
  calcNutrition();
}

function calcNutrition() {
  if (!currentNutrition) return;
  const g = parseFloat(document.getElementById('grams-input').value) || 0;
  const f = g / 100;
  document.getElementById('calc-grams').textContent = g;
  document.getElementById('c-kcal').textContent = Math.round(currentNutrition.kcal * f) + ' kcal';
  document.getElementById('c-protein').textContent = (currentNutrition.protein * f).toFixed(1) + 'g';
  document.getElementById('c-carbs').textContent = (currentNutrition.carbs * f).toFixed(1) + 'g';
  document.getElementById('c-fat').textContent = (currentNutrition.fat * f).toFixed(1) + 'g';
}

// =====================
// LOG FOOD
// =====================
function logFood() {
  if (!currentNutrition) return;
  const g = parseFloat(document.getElementById('grams-input').value) || 0;
  const f = g / 100;
  const entries = loadDayEntries(viewingDate);
  entries.push({
    id: Date.now(),
    name: currentNutrition.product_name || 'Produkt',
    grams: g,
    kcal: Math.round(currentNutrition.kcal * f),
    protein: +(currentNutrition.protein * f).toFixed(1),
    carbs: +(currentNutrition.carbs * f).toFixed(1),
    fat: +(currentNutrition.fat * f).toFixed(1),
    per100g: { kcal: currentNutrition.kcal, protein: currentNutrition.protein, carbs: currentNutrition.carbs, fat: currentNutrition.fat }
  });
  saveDayEntries(viewingDate, entries);
  renderLog();

  // Switch to log tab to show the added item
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-logg').classList.add('active');
  document.querySelector('.tab-btn').classList.add('active');
  activeTab = 'logg';
}

function deleteLog(dateKey, id) {
  const entries = loadDayEntries(dateKey).filter(e => e.id !== id);
  saveDayEntries(dateKey, entries);
  renderLog();
}

function renderLog() {
  const entries = loadDayEntries(viewingDate);
  const container = document.getElementById('log-items');

  if (entries.length === 0) {
    container.innerHTML = '<div class="empty-log">Inga matr√§tter loggade √§nnu.<br>Skanna en etikett eller ange manuellt.</div>';
  } else {
    container.innerHTML = entries.map(e =>
      '<div class="log-item">' +
        '<div>' +
          '<div class="log-item-name">' + e.name + '</div>' +
          '<div class="log-item-detail">' + e.grams + 'g &nbsp;¬∑&nbsp; P: ' + e.protein + 'g &nbsp;¬∑&nbsp; C: ' + e.carbs + 'g &nbsp;¬∑&nbsp; F: ' + e.fat + 'g</div>' +
        '</div>' +
        '<div style="display:flex;align-items:center;gap:0.25rem">' +
          '<span class="log-item-kcal">' + e.kcal + '</span>' +
          '<button class="edit-log" onclick="openEditModal(\'' + viewingDate + '\',' + e.id + ')" title="Redigera">‚úèÔ∏è</button>' +
          '<button class="delete-log" onclick="deleteLog(\'' + viewingDate + '\',' + e.id + ')">‚úï</button>' +
        '</div>' +
      '</div>'
    ).join('');
  }

  const tot = entries.reduce((a, e) => ({
    kcal: a.kcal + e.kcal, protein: a.protein + e.protein,
    carbs: a.carbs + e.carbs, fat: a.fat + e.fat
  }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

  document.getElementById('t-kcal').textContent = tot.kcal;
  document.getElementById('t-protein').textContent = tot.protein.toFixed(1) + 'g';
  document.getElementById('t-carbs').textContent = tot.carbs.toFixed(1) + 'g';
  document.getElementById('t-fat').textContent = tot.fat.toFixed(1) + 'g';
}

// =====================
// HISTORY
// =====================
function renderHistory() {
  const container = document.getElementById('history-list');
  const days = getAllLoggedDays();

  if (days.length === 0) {
    container.innerHTML = '<div class="no-history">Ingen historik √§nnu.<br>B√∂rja logga mat f√∂r att se din historik h√§r.</div>';
    return;
  }

  container.innerHTML = days.map(dateKey => {
    const entries = loadDayEntries(dateKey);
    const tot = entries.reduce((a, e) => ({
      kcal: a.kcal + e.kcal, protein: a.protein + e.protein,
      carbs: a.carbs + e.carbs, fat: a.fat + e.fat
    }), { kcal: 0, protein: 0, carbs: 0, fat: 0 });

    const itemsHtml = entries.map(e =>
      '<div class="log-item">' +
        '<div>' +
          '<div class="log-item-name">' + e.name + '</div>' +
          '<div class="log-item-detail">' + e.grams + 'g &nbsp;¬∑&nbsp; P: ' + e.protein + 'g &nbsp;¬∑&nbsp; C: ' + e.carbs + 'g &nbsp;¬∑&nbsp; F: ' + e.fat + 'g</div>' +
        '</div>' +
        '<div style="display:flex;align-items:center;gap:0.25rem">' +
          '<span class="log-item-kcal">' + e.kcal + '</span>' +
          '<button class="edit-log" onclick="openEditModal(\'' + dateKey + '\',' + e.id + ')" title="Redigera">‚úèÔ∏è</button>' +
          '<button class="delete-log" onclick="deleteLogAndRefresh(\'' + dateKey + '\',' + e.id + ')">‚úï</button>' +
        '</div>' +
      '</div>'
    ).join('');

    return '<div class="history-day" id="hday-' + dateKey + '">' +
      '<div class="history-day-header" onclick="toggleHistoryDay(\'' + dateKey + '\')">' +
        '<div>' +
          '<div class="history-day-date">' + getDateLabel(dateKey) + '</div>' +
          '<div style="font-size:0.68rem;color:var(--muted);margin-top:0.15rem">' + getDateSubLabel(dateKey) + '</div>' +
        '</div>' +
        '<div style="display:flex;align-items:center;gap:0.75rem">' +
          '<span class="history-day-kcal">' + tot.kcal + ' kcal</span>' +
          '<span class="history-day-chevron">‚ñº</span>' +
        '</div>' +
      '</div>' +
      '<div class="history-day-body">' +
        '<div class="history-macros">' +
          'üí™ Protein: <span>' + tot.protein.toFixed(1) + 'g</span>' +
          '&nbsp;&nbsp; üåæ Kolh: <span>' + tot.carbs.toFixed(1) + 'g</span>' +
          '&nbsp;&nbsp; üßà Fett: <span>' + tot.fat.toFixed(1) + 'g</span>' +
        '</div>' +
        itemsHtml +
      '</div>' +
    '</div>';
  }).join('');
}

function toggleHistoryDay(dateKey) {
  document.getElementById('hday-' + dateKey).classList.toggle('open');
}

function deleteLogAndRefresh(dateKey, id) {
  const entries = loadDayEntries(dateKey).filter(e => e.id !== id);
  saveDayEntries(dateKey, entries);
  renderHistory();
  if (dateKey === viewingDate) renderLog();
}

// =====================
// EDIT MODAL
// =====================
function openEditModal(dateKey, id) {
  const entries = loadDayEntries(dateKey);
  const entry = entries.find(e => e.id === id);
  if (!entry) return;
  editingId = id;
  editingDate = dateKey;
  document.getElementById('modal-product-name').textContent = entry.name;
  document.getElementById('modal-grams').value = entry.grams;
  updateModalPreview();
  document.getElementById('edit-modal').classList.add('open');
}

function closeEditModal() {
  editingId = null; editingDate = null;
  document.getElementById('edit-modal').classList.remove('open');
}

function updateModalPreview() {
  if (!editingDate) return;
  const entries = loadDayEntries(editingDate);
  const entry = entries.find(e => e.id === editingId);
  if (!entry) return;
  const g = parseFloat(document.getElementById('modal-grams').value) || 0;
  const f = g / 100;
  document.getElementById('mp-kcal').textContent = Math.round(entry.per100g.kcal * f) + ' kcal';
  document.getElementById('mp-protein').textContent = (entry.per100g.protein * f).toFixed(1) + 'g';
  document.getElementById('mp-carbs').textContent = (entry.per100g.carbs * f).toFixed(1) + 'g';
  document.getElementById('mp-fat').textContent = (entry.per100g.fat * f).toFixed(1) + 'g';
}

function saveEdit() {
  const entries = loadDayEntries(editingDate);
  const entry = entries.find(e => e.id === editingId);
  if (!entry) return;
  const g = parseFloat(document.getElementById('modal-grams').value) || 0;
  const f = g / 100;
  entry.grams = g;
  entry.kcal = Math.round(entry.per100g.kcal * f);
  entry.protein = +(entry.per100g.protein * f).toFixed(1);
  entry.carbs = +(entry.per100g.carbs * f).toFixed(1);
  entry.fat = +(entry.per100g.fat * f).toFixed(1);
  saveDayEntries(editingDate, entries);
  closeEditModal();
  renderLog();
  if (activeTab === 'historik') renderHistory();
}

document.getElementById('edit-modal').addEventListener('click', function(e) {
  if (e.target === this) closeEditModal();
});

// =====================
// MANUAL ENTRY
// =====================
function toggleManual() {
  const form = document.getElementById('manual-form');
  form.style.display = form.style.display === 'block' ? 'none' : 'block';
}

function useManual() {
  setNutrition({
    product_name: document.getElementById('m-name').value || 'Min produkt',
    kcal: parseFloat(document.getElementById('m-kcal').value) || 0,
    protein: parseFloat(document.getElementById('m-protein').value) || 0,
    carbs: parseFloat(document.getElementById('m-carbs').value) || 0,
    fat: parseFloat(document.getElementById('m-fat').value) || 0,
  });
  document.getElementById('manual-form').style.display = 'none';
}

// =====================
// UTILS
// =====================
function showLoading(v) {
  document.getElementById('loading').style.display = v ? 'block' : 'none';
  document.getElementById('analyze-btn').disabled = v;
  document.getElementById('analyze-btn').textContent = v ? '‚ü≥ Analyserar...' : '‚ú¶ Analysera n√§ringsetikett';
}
function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg; el.style.display = 'block';
}
function hideError() {
  document.getElementById('error-msg').style.display = 'none';
}

// =====================
// QUICK-ADD MODAL
// =====================
let qaNutrition = null;
let qaImageBase64 = null;
let qaImageMimeType = 'image/jpeg';

function openQuickAdd() {
  qaNutrition = null;
  qaImageBase64 = null;
  // Reset to step 1
  document.getElementById('qa-step-scan').classList.add('active');
  document.getElementById('qa-step-confirm').classList.remove('active');
  document.getElementById('qa-preview').style.display = 'none';
  document.getElementById('qa-analyze-btn').style.display = 'none';
  document.getElementById('qa-error').style.display = 'none';
  document.getElementById('qa-loading').style.display = 'none';
  document.getElementById('qa-manual-form').style.display = 'none';
  document.getElementById('qa-file-input').value = '';
  document.getElementById('qa-modal-overlay').classList.add('open');
}

function closeQuickAdd() {
  document.getElementById('qa-modal-overlay').classList.remove('open');
}

document.getElementById('qa-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeQuickAdd();
});

// File handling
document.getElementById('qa-file-input').addEventListener('change', e => qaHandleFile(e.target.files[0]));
document.getElementById('qa-camera-input').addEventListener('change', e => qaHandleFile(e.target.files[0]));

function triggerQACamera(e) {
  e.stopPropagation(); e.preventDefault();
  document.getElementById('qa-camera-input').click();
}

const qaUploadZone = document.getElementById('qa-upload-zone');
qaUploadZone.addEventListener('dragover', e => { e.preventDefault(); qaUploadZone.style.borderColor = 'var(--accent)'; });
qaUploadZone.addEventListener('dragleave', () => { qaUploadZone.style.borderColor = ''; });
qaUploadZone.addEventListener('drop', e => {
  e.preventDefault(); qaUploadZone.style.borderColor = '';
  if (e.dataTransfer.files[0]) qaHandleFile(e.dataTransfer.files[0]);
});

function qaHandleFile(file) {
  if (!file || !file.type.startsWith('image/')) return;
  qaImageMimeType = file.type || 'image/jpeg';
  const reader = new FileReader();
  reader.onload = ev => {
    const dataUrl = ev.target.result;
    qaImageBase64 = dataUrl.split(',')[1];
    document.getElementById('qa-preview-img').src = dataUrl;
    document.getElementById('qa-preview').style.display = 'block';
    document.getElementById('qa-analyze-btn').style.display = 'block';
    document.getElementById('qa-error').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

function removeQAImage() {
  qaImageBase64 = null;
  document.getElementById('qa-preview').style.display = 'none';
  document.getElementById('qa-analyze-btn').style.display = 'none';
  document.getElementById('qa-file-input').value = '';
}

async function qaAnalyzeImage() {
  if (!qaImageBase64) return;
  const apiKey = getApiKey();
  if (!apiKey) { qaShowError('Ange din Gemini API-nyckel under Inst√§llningar f√∂rst.'); return; }

  document.getElementById('qa-analyze-btn').disabled = true;
  document.getElementById('qa-analyze-btn').textContent = '‚ü≥ Analyserar...';
  document.getElementById('qa-loading').style.display = 'block';
  document.getElementById('qa-error').style.display = 'none';

  try {
    const response = await fetch(
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + apiKey,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { inline_data: { mime_type: qaImageMimeType, data: qaImageBase64 } },
              { text: 'Analysera denna n√§ringsetikettsbild och extrahera n√§ringsv√§rdena per 100g.\nSvara ENDAST med ett giltigt JSON-objekt, ingen markdown, ingen f√∂rklaring:\n{"product_name":"produktnamn eller b√§sta gissning","kcal":number,"protein":number,"carbs":number,"fat":number}\nOm v√§rdena √§r per portion, konvertera till per 100g. Returnera alltid JSON.' }
            ]
          }]
        })
      }
    );
    const data = await response.json();
    if (!response.ok) throw new Error(data?.error?.message || 'API-fel');
    const text = data.candidates?.[0]?.content?.parts?.map(p => p.text || '').join('') || '';
    const clean = text.replace(/```json|```/g, '').trim();
    qaSetNutrition(JSON.parse(clean));
  } catch(err) {
    qaShowError('Kunde inte l√§sa etiketten: ' + (err.message || 'ok√§nt fel'));
    document.getElementById('qa-analyze-btn').disabled = false;
    document.getElementById('qa-analyze-btn').textContent = '‚ú¶ Analysera etikett';
  }
  document.getElementById('qa-loading').style.display = 'none';
}

function toggleQAManual() {
  const form = document.getElementById('qa-manual-form');
  form.style.display = form.style.display === 'block' ? 'none' : 'block';
}

function qaUseManual() {
  qaSetNutrition({
    product_name: document.getElementById('qa-m-name').value || 'Min produkt',
    kcal: parseFloat(document.getElementById('qa-m-kcal').value) || 0,
    protein: parseFloat(document.getElementById('qa-m-protein').value) || 0,
    carbs: parseFloat(document.getElementById('qa-m-carbs').value) || 0,
    fat: parseFloat(document.getElementById('qa-m-fat').value) || 0,
  });
}

function qaSetNutrition(n) {
  qaNutrition = n;
  document.getElementById('qa-result-name').textContent = n.product_name || 'Produkt';
  document.getElementById('qa-p-kcal').textContent = Math.round(n.kcal);
  document.getElementById('qa-p-protein').textContent = (+n.protein).toFixed(1) + 'g';
  document.getElementById('qa-p-carbs').textContent = (+n.carbs).toFixed(1) + 'g';
  document.getElementById('qa-p-fat').textContent = (+n.fat).toFixed(1) + 'g';
  document.getElementById('qa-grams').value = 100;
  qaCalc();
  // Switch to confirm step
  document.getElementById('qa-step-scan').classList.remove('active');
  document.getElementById('qa-step-confirm').classList.add('active');
}

function qaCalc() {
  if (!qaNutrition) return;
  const g = parseFloat(document.getElementById('qa-grams').value) || 0;
  const f = g / 100;
  document.getElementById('qa-c-kcal').textContent = Math.round(qaNutrition.kcal * f) + ' kcal';
  document.getElementById('qa-c-protein').textContent = (qaNutrition.protein * f).toFixed(1) + 'g';
  document.getElementById('qa-c-carbs').textContent = (qaNutrition.carbs * f).toFixed(1) + 'g';
  document.getElementById('qa-c-fat').textContent = (qaNutrition.fat * f).toFixed(1) + 'g';
}

function qaLogFood() {
  if (!qaNutrition) return;
  const g = parseFloat(document.getElementById('qa-grams').value) || 0;
  const f = g / 100;
  const entries = loadDayEntries(viewingDate);
  entries.push({
    id: Date.now(),
    name: qaNutrition.product_name || 'Produkt',
    grams: g,
    kcal: Math.round(qaNutrition.kcal * f),
    protein: +(qaNutrition.protein * f).toFixed(1),
    carbs: +(qaNutrition.carbs * f).toFixed(1),
    fat: +(qaNutrition.fat * f).toFixed(1),
    per100g: { kcal: qaNutrition.kcal, protein: qaNutrition.protein, carbs: qaNutrition.carbs, fat: qaNutrition.fat }
  });
  saveDayEntries(viewingDate, entries);
  renderLog();
  closeQuickAdd();
}

function qaBackToScan() {
  document.getElementById('qa-step-confirm').classList.remove('active');
  document.getElementById('qa-step-scan').classList.add('active');
  document.getElementById('qa-analyze-btn').disabled = false;
  document.getElementById('qa-analyze-btn').textContent = '‚ú¶ Analysera etikett';
}

function qaShowError(msg) {
  const el = document.getElementById('qa-error');
  el.textContent = msg; el.style.display = 'block';
}

// =====================
// INIT
// =====================
window.addEventListener('load', () => {
  const saved = localStorage.getItem('gemini_api_key');
  if (saved) {
    document.getElementById('api-key-input').value = saved;
    setApiStatus('‚úì Sparad nyckel laddad', 'var(--muted)');
  }
  updateDateDisplay();
  renderLog();
});
</script>
</body>
</html>